name: Publish

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      version:
        description: "Version to publish (e.g., 0.1.0)"
        required: true
        type: string
      publish-npm:
        description: "Publish @514labs/moose-lsp to npm"
        required: false
        type: boolean
        default: true
      publish-vscode:
        description: "Publish VS Code extension to marketplace"
        required: false
        type: boolean
        default: true
      publish-openvsx:
        description: "Publish to Open VSX (for Cursor)"
        required: false
        type: boolean
        default: true
  workflow_call:
    inputs:
      version:
        required: true
        type: string
      npm-tag:
        required: false
        type: string
        default: "latest"
      pre-release:
        required: false
        type: boolean
        default: false
    secrets:
      NPM_TOKEN:
        required: true
      VSCE_PAT:
        required: true
      OVSX_PAT:
        required: true

concurrency:
  group: publish-${{ inputs.version || github.event.release.tag_name }}
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9.9.0

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm
          registry-url: "https://registry.npmjs.org"

      - name: Setup Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: stable

      - name: Install wasm-pack
        uses: taiki-e/install-action@wasm-pack

      - name: Install dependencies
        run: pnpm install

      - name: Get version
        id: version
        env:
          INPUT_VERSION: ${{ inputs.version }}
          RELEASE_TAG: ${{ github.event.release.tag_name }}
        run: |
          if [ -n "${INPUT_VERSION}" ]; then
            VERSION="${INPUT_VERSION}"
          else
            VERSION="${RELEASE_TAG}"
            VERSION="${VERSION#v}"
          fi
          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"
          echo "Publishing version: ${VERSION}"

      - name: Validate version format
        env:
          VERSION: ${{ steps.version.outputs.version }}
        run: |
          if ! echo "${VERSION}" | grep -qE '^[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9.]+)?(\+[a-zA-Z0-9.]+)?$'; then
            echo "::error::Invalid semver version: '${VERSION}'"
            exit 1
          fi

      - name: Set version across all packages
        env:
          VERSION: ${{ steps.version.outputs.version }}
        run: |
          npm version "${VERSION}" --no-git-tag-version
          cd packages/sql-validator-wasm && npm version "${VERSION}" --no-git-tag-version && cd ../..
          cd packages/lsp-server && npm version "${VERSION}" --no-git-tag-version && cd ../..
          cd packages/vscode-extension && npm version "${VERSION}" --no-git-tag-version && cd ../..

      - name: Build all packages
        run: pnpm build

      - name: Resolve publish settings
        id: settings
        env:
          INPUT_PRE_RELEASE: ${{ inputs.pre-release }}
          INPUT_NPM_TAG: ${{ inputs.npm-tag }}
        run: |
          PRE_RELEASE="${INPUT_PRE_RELEASE:-false}"
          NPM_TAG="${INPUT_NPM_TAG:-latest}"
          echo "pre-release=${PRE_RELEASE}" >> "$GITHUB_OUTPUT"
          echo "npm-tag=${NPM_TAG}" >> "$GITHUB_OUTPUT"
          echo "Pre-release: ${PRE_RELEASE}, npm tag: ${NPM_TAG}"

      - name: Prepare extension server bundle
        run: |
          # Use server/ directory instead of node_modules/ to avoid .gitignore issues
          # The wasm package must be in node_modules relative to server.js for Node resolution
          mkdir -p packages/vscode-extension/server/@514labs/moose-lsp/node_modules/@514labs/moose-sql-validator-wasm

          # Copy bundled lsp-server (dependencies are bundled in server.js)
          cp packages/lsp-server/dist/server.js packages/vscode-extension/server/@514labs/moose-lsp/
          cp packages/lsp-server/dist/server.js.map packages/vscode-extension/server/@514labs/moose-lsp/
          cp -r packages/lsp-server/dist/data packages/vscode-extension/server/@514labs/moose-lsp/

          # Create minimal package.json (deps are bundled, only wasm is external)
          node -e "
            const pkg = require('./packages/lsp-server/package.json');
            pkg.dependencies = {'@514labs/moose-sql-validator-wasm': '*'};
            pkg.main = 'server.js';
            require('fs').writeFileSync('packages/vscode-extension/server/@514labs/moose-lsp/package.json', JSON.stringify(pkg, null, 2));
          "

          # Copy sql-validator-wasm into node_modules for Node.js module resolution
          cp -r packages/lsp-server/dist/node_modules/@514labs/moose-sql-validator-wasm/* packages/vscode-extension/server/@514labs/moose-lsp/node_modules/@514labs/moose-sql-validator-wasm/

      - name: Install vsce
        run: npm install -g @vscode/vsce

      - name: Package extension
        env:
          PRE_RELEASE: ${{ steps.settings.outputs.pre-release }}
        run: |
          cd packages/vscode-extension
          if [ "${PRE_RELEASE}" == "true" ]; then
            vsce package --no-dependencies --pre-release
          else
            vsce package --no-dependencies
          fi

      - name: Upload npm build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: npm-build-output
          path: |
            packages/lsp-server/dist/
            packages/lsp-server/package.json
            packages/sql-validator-wasm/dist/
            packages/sql-validator-wasm/pkg/
            packages/sql-validator-wasm/package.json
          retention-days: 3

      - name: Upload extension vsix
        uses: actions/upload-artifact@v4
        with:
          name: extension-vsix
          path: packages/vscode-extension/*.vsix
          retention-days: 3

    outputs:
      version: ${{ steps.version.outputs.version }}
      pre-release: ${{ steps.settings.outputs.pre-release }}
      npm-tag: ${{ steps.settings.outputs.npm-tag }}

  publish-npm:
    needs: build
    if: ${{ github.event.inputs.publish-npm != 'false' }}
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: npm-build-output

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          registry-url: "https://registry.npmjs.org"

      - name: Publish @514labs/moose-lsp to npm
        env:
          NPM_TAG: ${{ needs.build.outputs.npm-tag }}
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          cd lsp-server
          # Remove bundled workspace dependency (it's included in dist/node_modules)
          node -e "const pkg = require('./package.json'); delete pkg.dependencies['@514labs/moose-sql-validator-wasm']; require('fs').writeFileSync('package.json', JSON.stringify(pkg, null, 2))"
          npm publish --access public --tag "${NPM_TAG}"

  publish-vscode:
    needs: build
    if: ${{ github.event.inputs.publish-vscode != 'false' }}
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Download extension vsix
        uses: actions/download-artifact@v4
        with:
          name: extension-vsix

      - uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install vsce
        run: npm install -g @vscode/vsce

      - name: Publish to VS Code Marketplace
        env:
          PRE_RELEASE: ${{ needs.build.outputs.pre-release }}
          VSCE_PAT: ${{ secrets.VSCE_PAT }}
        run: |
          shopt -s nullglob
          vsix_files=( *.vsix )
          if [ "${#vsix_files[@]}" -ne 1 ]; then
            echo "::error::Expected exactly one .vsix file, found ${#vsix_files[@]}: ${vsix_files[*]}"
            exit 1
          fi
          if [ "${PRE_RELEASE}" == "true" ]; then
            vsce publish --packagePath "${vsix_files[0]}" --pre-release
          else
            vsce publish --packagePath "${vsix_files[0]}"
          fi

  publish-openvsx:
    needs: build
    if: ${{ github.event.inputs.publish-openvsx != 'false' }}
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Download extension vsix
        uses: actions/download-artifact@v4
        with:
          name: extension-vsix

      - uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install ovsx
        run: npm install -g ovsx

      - name: Publish to Open VSX
        env:
          PRE_RELEASE: ${{ needs.build.outputs.pre-release }}
          OVSX_PAT: ${{ secrets.OVSX_PAT }}
        run: |
          shopt -s nullglob
          vsix_files=( *.vsix )
          if [ "${#vsix_files[@]}" -ne 1 ]; then
            echo "::error::Expected exactly one .vsix file, found ${#vsix_files[@]}: ${vsix_files[*]}"
            exit 1
          fi
          if [ "${PRE_RELEASE}" == "true" ]; then
            ovsx publish "${vsix_files[0]}" --pre-release
          else
            ovsx publish "${vsix_files[0]}"
          fi
