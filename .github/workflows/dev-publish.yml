name: Dev Publish

on:
  pull_request:
    branches: [main]

permissions:
  contents: read

concurrency:
  group: dev-publish-pr-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  compute-version:
    runs-on: ubuntu-latest
    if: github.event.pull_request.head.repo.full_name == github.repository
    outputs:
      version: ${{ steps.version.outputs.version }}
    steps:
      - uses: actions/checkout@v4
      - name: Compute dev version
        id: version
        env:
          PR_NUMBER: ${{ github.event.pull_request.number }}
          RUN_NUMBER: ${{ github.run_number }}
          RUN_ATTEMPT: ${{ github.run_attempt }}
        run: |
          CURRENT_VERSION=$(node -p "require('./packages/lsp-server/package.json').version")
          DEV_VERSION="${CURRENT_VERSION}-dev.${PR_NUMBER}.${RUN_NUMBER}.${RUN_ATTEMPT}"
          echo "version=${DEV_VERSION}" >> "$GITHUB_OUTPUT"
          echo "Dev version: ${DEV_VERSION}"

  publish:
    needs: compute-version
    uses: ./.github/workflows/publish.yml
    with:
      version: ${{ needs.compute-version.outputs.version }}
      npm-tag: dev
      pre-release: true
    secrets:
      NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
      VSCE_PAT: ${{ secrets.VSCE_PAT }}
      OVSX_PAT: ${{ secrets.OVSX_PAT }}
